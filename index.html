<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Llaves - Riba Smith</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script> 

    <link rel="manifest" href="manifest.json">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Fondo muy suave gris claro (slate-100) */
        }
        /* Colores y Contenedor Principal (Minimalista) */
        .app-container {
            @apply max-w-4xl mx-auto p-4 md:p-8;
        }
        .card {
            /* Estilo plano y minimalista */
            @apply bg-white p-6 md:p-8 rounded-lg shadow-sm border border-gray-200;
        }
        .btn-primary {
            /* Azul Corporativo */
            @apply px-8 py-3 font-bold text-white bg-blue-900 rounded-md hover:bg-blue-800 transition-colors duration-200 focus:outline-none focus:ring-4 focus:ring-blue-300/70;
        }
        .btn-success {
            @apply px-4 py-2 font-semibold text-white bg-emerald-600 rounded-md hover:bg-emerald-700 transition-colors duration-200 focus:outline-none focus:ring-4 focus:ring-emerald-300;
        }
        .btn-report {
            @apply px-6 py-2.5 font-bold text-white bg-red-700 rounded-md shadow-md hover:bg-red-800 transition-colors duration-200 focus:outline-none focus:ring-4 focus:ring-red-300;
        }
        /* Estilo para los inputs minimalistas (border-bottom) */
        .app-input {
            @apply mt-1 block w-full border-0 border-b-2 border-gray-300 bg-white p-2 focus:ring-0 focus:border-blue-900 appearance-none transition-colors duration-200;
        }
        /* T√≠tulos de secci√≥n */
        .section-title {
             @apply text-xl font-extrabold text-blue-900 mb-6 pb-3 border-b-2 border-gray-200 flex items-center space-x-2;
        }
    </style>
</head>
<body>

    <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md border-t-4 border-blue-900">
            <h3 class="text-3xl font-extrabold mb-2 text-blue-900 text-center">üîë Control de Llaves</h3>
            <p class="text-gray-600 mb-8 text-center text-sm">Acceso de Agentes (Riba Smith)</p>

            <form id="login-form" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-semibold text-gray-700">Nombre de Agente</label>
                    <select id="username" name="username" required 
                           class="app-input">
                        <option value="">-- Seleccione su Nombre --</option>
                        <option value="Rafael Ramos">Rafael Ramos</option>
                        <option value="Jos√© Guevara">Jos√© Guevara</option>
                        <option value="Ariel Bernal">Ariel Bernal</option>
                        <option value="Oriel Aizprua">Oriel Aizprua</option>
                        <option value="Leandro P√©rez">Leandro P√©rez</option>
                        <option value="Samuel Reyes">Samuel Reyes</option>
                    </select>
                </div>

                <div>
                    <label for="password" class="block text-sm font-semibold text-gray-700">Contrase√±a</label>
                    <input type="password" id="password" name="password" required 
                           class="app-input"
                           placeholder="Contrase√±a de Agente">
                </div>

                <div id="login-error" class="hidden text-red-600 text-sm font-semibold pt-2">Credenciales incorrectas. Verifique nombre y contrase√±a.</div>

                <button type="submit" class="btn-primary w-full mt-6">
                    Iniciar Sesi√≥n
                </button>
            </form>
        </div>
    </div>
    
    <div id="main-app-content" class="app-container hidden">

        <header class="py-6 mb-8 border-b border-gray-300 flex justify-between items-center">
            <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-blue-900">Control de Activos</h1>
            <div class="flex items-center space-x-4">
                 <div class="flex items-center space-x-2 text-sm text-gray-600">
                    <p class="font-semibold text-gray-500">ID:</p>
                    <span id="security-id" class="font-mono text-xs bg-gray-200 text-blue-900 p-2 rounded-md font-bold"></span>
                </div>
                <button id="logout-btn" onclick="handleLogout()" class="px-4 py-2 font-semibold text-sm bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
                    Cerrar Sesi√≥n
                </button>
            </div>
        </header>

        <div id="message-container"></div>
        
        <div class="mb-8 flex justify-end">
            <button id="end-day-report-btn" onclick="generateDailyReportPdf()" class="btn-report flex items-center space-x-2 text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M14 3v4a1 1 0 0 0 1 1h4"></path><path d="M17 21H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7l5 5v11a2 2 0 0 1-2 2z"></path><line x1="10" y1="13" x2="14" y2="13"></line><line x1="12" y1="17" x2="12" y2="17"></line></svg>
                <span>Terminar D√≠a (Generar Reporte PDF)</span>
            </button>
        </div>

        <div class="grid grid-cols-1 gap-12">
            
            <div id="checkout-section" class="card">
                <h2 class="section-title">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" /></svg>
                    <span>1. Registrar Entrega de Llave</span>
                </h2>

                <form id="checkout-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <label for="userName" class="block text-sm font-semibold text-gray-700">Usuario que Solicita</label>
                            <select id="userName" name="userName" required class="app-input">
                                <option value="">-- Seleccione Usuario --</option>
                                <option value="Rafael Ramos">Rafael Ramos</option>
                                <option value="Jos√© Guevara">Jos√© Guevara</option>
                                <option value="Ariel Bernal">Ariel Bernal</option>
                                <option value="Oriel Aizprua">Oriel Aizprua</option>
                                <option value="Leandro P√©rez">Leandro P√©rez</option>
                                <option value="Samuel Reyes">Samuel Reyes</option>
                            </select>
                        </div>

                        <div>
                            <label for="keyRequested" class="block text-sm font-semibold text-gray-700">Llave/Activo Solicitado</label>
                            <select id="keyRequested" name="keyRequested" required class="app-input">
                                <option value="">-- Seleccione Activo --</option>
                                <option value="Deposito">Deposito</option>
                                <option value="Contenedor">Contenedor</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="checkoutLocation" class="block text-sm font-semibold text-gray-700">Departamento de Destino</label>
                        <select id="checkoutLocation" name="checkoutLocation" required class="app-input">
                            <option value="">-- Seleccione Departamento --</option>
                            <option value="Rimith">Rimith</option>
                            <option value="Nevera">Nevera</option>
                            <option value="Panaderia">Panader√≠a</option>
                            <option value="Estanteria">Estanter√≠a</option>
                            <option value="Sanidad">Sanidad</option>
                            <option value="Recibo">Recibo</option>
                        </select>
                    </div>
                    
                    <div class="py-4 border-t border-gray-100">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Firma del Solicitante (Entregado)</label>
                        <div class="border border-gray-300 rounded-md bg-white p-1 h-32 shadow-inner">
                            <canvas id="signature-pad-checkout" width="400" height="120" class="w-full h-full bg-white rounded-sm cursor-crosshair"></canvas>
                        </div>
                        <button type="button" id="clear-signature-checkout" class="mt-3 px-3 py-1 text-xs font-semibold text-gray-600 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors">Borrar Firma</button>
                    </div>
                    
                    <div>
                        <label for="checkoutObservation" class="block text-sm font-semibold text-gray-700">Observaci√≥n (Opcional)</label>
                        <textarea id="checkoutObservation" name="checkoutObservation" rows="2" class="app-input"></textarea>
                    </div>

                    <button type="submit" id="checkout-submit-btn" class="btn-primary w-full mt-8">
                        <span id="submit-text">‚úÖ Registrar Entrega Ahora</span>
                        <span id="submit-loading" class="hidden flex items-center justify-center">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            Guardando...
                        </span>
                    </button>
                </form>
            </div>

            <div id="pending-section" class="card">
                <h2 class="section-title">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                    <span>2. Llaves Pendientes de Devoluci√≥n</span>
                </h2>

                <div id="key-list-container">
                    <div id="key-list-loading" class="text-center py-8 text-gray-500">
                        <svg class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-900 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"></svg>
                        Cargando historial de llaves...
                    </div>
                    <div id="pending-keys-list" class="space-y-4">
                        </div>
                    <div id="key-list-empty" class="hidden text-center py-8 text-gray-500">
                        <p class="text-lg font-semibold text-emerald-600">üéâ ¬°Todas las llaves han sido devueltas! No hay registros pendientes.</p>
                        <p class="text-sm text-gray-400 mt-1">Proceda a Generar el Reporte PDF para finalizar el turno.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="return-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md border-t-4 border-emerald-600">
                <h3 class="text-xl font-bold mb-4 text-emerald-700 border-b pb-2 flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-7.388 7.388A4 4 0 016.757 14H5v-2.043a4 4 0 011.172-2.828l7.386-7.386zM11.609 3.868l1.76-1.76c.4-.4 1.047-.4 1.447 0l1.76 1.76c.4.4.4 1.047 0 1.447l-1.76 1.76-1.447-1.447L12.56 5.315c-.4-.4-1.047-.4-1.447 0l-1.76 1.76 1.447 1.447-1.76 1.76L8.01 10.74l-2.09 2.09c-.4.4-1.047.4-1.447 0L2.71 11.33c-.4-.4-.4-1.047 0-1.447L9.492 2.18c.4-.4 1.047-.4 1.447 0z" /></svg>
                    <span>Confirmar Devoluci√≥n</span>
                </h3>
                <p class="text-gray-600 mb-2">Activo: <strong id="modal-key-name" class="text-emerald-600 font-extrabold"></strong></p>
                <p class="text-gray-500 text-sm mb-4">Solicitada por: <span id="modal-user-name" class="font-semibold"></span></p>

                <form id="return-form" class="space-y-4">
                    <div>
                        <label for="returnLocation" class="block text-sm font-semibold text-gray-700">Lugar de Devoluci√≥n</label>
                        <select id="returnLocation" name="returnLocation" required class="app-input">
                            <option value="">-- Seleccione Lugar --</option>
                            <option value="Seguridad Interno">Seguridad Interno</option>
                            <option value="Oficina de seguridad">Oficina de seguridad</option>
                            <option value="Entregada a otro personal">Entregada a otro personal</option>
                            </select>
                    </div>

                    <div>
                        <label for="returnObservation" class="block text-sm font-semibold text-gray-700">Observaci√≥n de Devoluci√≥n (Opcional)</label>
                        <textarea id="returnObservation" name="returnObservation" rows="2" class="app-input"></textarea>
                    </div>

                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeReturnModal()" class="px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors duration-200">Cancelar</button>
                        <button type="submit" id="confirm-return-btn" class="btn-success">
                            <span id="return-submit-text">Confirmar Devoluci√≥n</span>
                            <span id="return-submit-loading" class="hidden flex items-center justify-center">
                                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                Procesando...
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <script>
        const STORAGE_KEY = 'keyControlLogs';
        const SESSION_KEY = 'currentSecurityId';

        // --- Nombres de Guardia de Seguridad y sus credenciales ---
        const VALID_USERS = {
            'Rafael Ramos': { password: '1234', id: 'RR 19075' },
            'Jos√© Guevara': { password: '1234', id: 'JG 5604' },
            'Ariel Bernal': { password: '1234', id: 'AB 22750' },
            'Oriel Aizprua': { password: '1234', id: 'OA 17411' },
            'Leandro P√©rez': { password: '1234', id: 'LP 26511' },
            'Samuel Reyes': { password: '1234', id: 'SR 26113' }
        };

        let securityId = null; 
        let signaturePadCheckout; 

        // --- 1. AUTHENTICATION FUNCTIONS ---

        function updateUIForLogin(id) {
            securityId = id;
            document.getElementById('security-id').textContent = id;
            document.getElementById('main-app-content').classList.remove('hidden');
            document.getElementById('login-modal').classList.add('hidden');
            renderKeyList(); 
        }

        function handleLogin(e) {
            e.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorDiv = document.getElementById('login-error');

            if (VALID_USERS[username] && VALID_USERS[username].password === password) {
                sessionStorage.setItem(SESSION_KEY, VALID_USERS[username].id);
                updateUIForLogin(VALID_USERS[username].id);
                errorDiv.classList.add('hidden');
                showMessage(`Bienvenido, ${username}! (ID: ${VALID_USERS[username].id})`, 'success');
            } else {
                errorDiv.classList.remove('hidden');
            }
        }

        window.handleLogout = function() {
            sessionStorage.removeItem(SESSION_KEY);
            securityId = null;
            document.getElementById('main-app-content').classList.add('hidden');
            document.getElementById('login-modal').classList.remove('hidden');
            showMessage("Sesi√≥n cerrada correctamente.", 'info');
        }

        function checkLoginStatus() {
            const storedId = sessionStorage.getItem(SESSION_KEY);
            if (storedId && Object.values(VALID_USERS).some(user => user.id === storedId)) {
                updateUIForLogin(storedId);
            } else {
                document.getElementById('login-modal').classList.remove('hidden');
                document.getElementById('main-app-content').classList.add('hidden');
            }
        }


        // --- 2. UTILITY FUNCTIONS ---

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function loadLogs() {
            try {
                const json = localStorage.getItem(STORAGE_KEY);
                return json ? JSON.parse(json) : [];
            } catch (error) {
                console.error("Error al cargar logs de localStorage:", error);
                return [];
            }
        }

        function saveLogs(logs) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
            } catch (error) {
                console.error("Error al guardar logs en localStorage:", error);
                showMessage("Error al guardar datos. El almacenamiento local est√° lleno.", 'error');
            }
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            const dateOptions = { year: 'numeric', month: 'short', day: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit' };

            return `${date.toLocaleDateString('es-ES', dateOptions)} ${date.toLocaleTimeString('es-ES', timeOptions)}`;
        }

        function formatTimeForPdf(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', hour12: false });
        }

        function showMessage(message, type = 'info') {
            const container = document.getElementById('message-container');
            let bgColor = 'bg-blue-100 border-blue-400 text-blue-700';
            let icon = '‚ÑπÔ∏è';
            if (type === 'error') { bgColor = 'bg-red-100 border-red-400 text-red-700'; icon = '‚ùå'; }
            if (type === 'success') { bgColor = 'bg-emerald-100 border-emerald-400 text-emerald-700'; icon = '‚úÖ'; }

            const msgDiv = document.createElement('div');
            msgDiv.className = `p-4 rounded-lg shadow-sm border ${bgColor} mb-4 flex items-center space-x-3 transition-opacity duration-300`;
            msgDiv.innerHTML = `<span class="text-2xl">${icon}</span><p class="font-medium">${message}</p>`;

            container.innerHTML = '';
            container.appendChild(msgDiv);

            setTimeout(() => {
                msgDiv.classList.add('opacity-0');
                msgDiv.addEventListener('transitionend', () => msgDiv.remove());
            }, 5000);
        }

        function getStartOfToday() {
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            return now.getTime();
        }

        // --- SOLUCI√ìN CLAVE: REDIMENSIONAR FIRMA PARA EVITAR LA BARRA NEGRA EN PDF ---
        /**
         * Redimensiona la firma del canvas a un tama√±o peque√±o (100x40 p√≠xeles) para 
         * asegurar que jsPDF pueda procesarla correctamente sin la barra negra.
         * @param {string} dataURL - La Data URL de la firma (image/png).
         * @returns {string} La Data URL de la imagen redimensionada o null.
         */
        function getResizedSignature(dataURL) {
            if (!dataURL) return null;

            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Tama√±o peque√±o y fijo para el PDF (ej. 100px ancho x 40px alto)
                    const targetWidth = 100; 
                    const targetHeight = 40; 
                    
                    canvas.width = targetWidth;
                    canvas.height = targetHeight;
                    
                    // Dibujar la imagen original en el nuevo canvas con las dimensiones objetivo
                    ctx.drawImage(img, 0, 0, targetWidth, targetHeight);

                    // Devolver la nueva Data URL, ahora ligera y redimensionada
                    const resizedDataURL = canvas.toDataURL('image/png');
                    resolve(resizedDataURL);
                };
                img.onerror = () => {
                    console.error("Error al cargar la imagen de la firma para redimensionar.");
                    resolve(null);
                };
                img.src = dataURL;
            });
        }

        // --- 3. INITIALIZATION AND UI SETUP ---

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('checkout-form').addEventListener('submit', handleCheckout);
            document.getElementById('return-form').addEventListener('submit', handleReturn);
            document.getElementById('login-form').addEventListener('submit', handleLogin);

            const canvasCheckout = document.getElementById('signature-pad-checkout');
            if (canvasCheckout) {
                
                // Funci√≥n de redimensionamiento mejorada y forzada
                function resizeCanvas() {
                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                    canvasCheckout.width = canvasCheckout.offsetWidth * ratio; 
                    canvasCheckout.height = canvasCheckout.offsetHeight * ratio;
                    canvasCheckout.getContext("2d").scale(ratio, ratio);
                }

                // Forzar la primera ejecuci√≥n para que tenga altura ANTES de SignaturePad
                resizeCanvas(); 
                setTimeout(resizeCanvas, 100); 

                window.addEventListener('resize', resizeCanvas);

                signaturePadCheckout = new SignaturePad(canvasCheckout, {
                    backgroundColor: 'rgb(255, 255, 255)', 
                    penColor: 'rgb(25, 29, 68)' // Azul Oscuro
                });

                document.getElementById('clear-signature-checkout').addEventListener('click', () => {
                    signaturePadCheckout.clear();
                });
            }

            checkLoginStatus();
            document.getElementById('key-list-loading').classList.add('hidden');
        });


        // --- 4. REGISTRAR ENTREGA DE LLAVE (CHECKOUT) CON FIRMA ---
        async function handleCheckout(e) {
            e.preventDefault();

            if (!securityId) {
                showMessage("Debe iniciar sesi√≥n para registrar una entrega.", 'error');
                return;
            }

            if (signaturePadCheckout && signaturePadCheckout.isEmpty()) {
                showMessage("Por favor, el solicitante debe firmar en el recuadro antes de registrar la entrega.", 'error');
                return;
            }

            const submitText = document.getElementById('submit-text');
            const submitLoading = document.getElementById('submit-loading');
            const checkoutSubmitBtn = document.getElementById('checkout-submit-btn');

            checkoutSubmitBtn.disabled = true;
            submitText.classList.add('hidden');
            submitLoading.classList.remove('hidden');

            const formData = new FormData(e.target);
            
            // 1. Obtener la Data URL original de la firma como PNG
            const originalSignatureDataURL = signaturePadCheckout ? 
                signaturePadCheckout.toDataURL('image/png') : 
                null;
                
            // 2. REDIMENSIONAR ANTES DE GUARDAR (SOLUCI√ìN AL ERROR DEL PDF)
            const resizedSignature = await getResizedSignature(originalSignatureDataURL);


            const newLog = {
                id: generateUUID(), 
                userName: formData.get('userName').trim(), 
                keyRequested: formData.get('keyRequested').trim(), 
                checkoutLocation: formData.get('checkoutLocation'), 
                checkoutObservation: formData.get('checkoutObservation').trim() || 'N/A',
                isReturned: false, 

                checkoutTime: Date.now(), 
                checkoutUserId: securityId, 
                
                // GUARDAR FIRMA PEQUE√ëA Y OPTIMIZADA
                checkoutSignature: resizedSignature, 
            };

            const logs = loadLogs();
            logs.push(newLog);
            saveLogs(logs);
            renderKeyList();

            showMessage("Entrega de llave registrada con √©xito.", 'success');
            e.target.reset(); 
            if (signaturePadCheckout) signaturePadCheckout.clear(); 

            checkoutSubmitBtn.disabled = false;
            submitText.classList.remove('hidden');
            submitLoading.classList.add('hidden');
        }


        // --- 5. RENDERIZAR LISTA DE LLAVES PENDIENTES ---
        function renderKeyList() {
            const logs = loadLogs();
            const pendingKeys = logs.filter(log => !log.isReturned);

            pendingKeys.sort((a, b) => a.checkoutTime - b.checkoutTime);

            const pendingKeysList = document.getElementById('pending-keys-list');
            const keyListEmpty = document.getElementById('key-list-empty');

            pendingKeysList.innerHTML = ''; 

            if (pendingKeys.length === 0) {
                keyListEmpty.classList.remove('hidden');
                return;
            }

            keyListEmpty.classList.add('hidden');

            pendingKeys.forEach(key => {
                const checkoutTimeFormatted = formatTimestamp(key.checkoutTime);

                const keyCard = document.createElement('div');
                keyCard.className = 'card bg-yellow-50 border-l-4 border-yellow-500 shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-3 sm:space-y-0 p-4';
                keyCard.innerHTML = `
                    <div class="flex-1 w-full">
                        <p class="text-xl font-extrabold text-gray-800">${key.keyRequested}</p>
                        <p class="text-sm text-gray-700 mb-1">
                            <span class="font-bold">Solicita:</span> ${key.userName} 
                            <span class="text-xs text-gray-500 ml-2">(${key.checkoutLocation})</span>
                        </p>
                        <p class="text-xs text-gray-500 mt-1">
                            <span class="font-bold text-blue-900">ENTREGA:</span> ${checkoutTimeFormatted} 
                            <span class="text-gray-400">por ${key.checkoutUserId}</span>
                        </p>
                        <p class="text-xs text-gray-500 italic mt-0.5">Obs: ${key.checkoutObservation}</p>
                    </div>
                    <button data-id="${key.id}" data-key="${key.keyRequested}" data-user="${key.userName}" 
                            class="btn-success w-full sm:w-auto log-return-btn text-sm">
                        RETORNA
                    </button>
                `;
                pendingKeysList.appendChild(keyCard);
            });

            document.querySelectorAll('.log-return-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const docId = e.currentTarget.getAttribute('data-id');
                    const keyName = e.currentTarget.getAttribute('data-key');
                    const userName = e.currentTarget.getAttribute('data-user');
                    openReturnModal(docId, keyName, userName);
                });
            });
        }

        // --- 6. GESTI√ìN DEL MODAL Y DEVOLUCI√ìN ---
        const returnModal = document.getElementById('return-modal');
        const modalKeyName = document.getElementById('modal-key-name');
        const modalUserName = document.getElementById('modal-user-name');
        let currentEditingDocId = null;

        window.openReturnModal = (docId, keyName, userName) => {
            currentEditingDocId = docId;
            modalKeyName.textContent = keyName;
            modalUserName.textContent = userName;
            returnModal.classList.remove('hidden');
            returnModal.classList.add('flex');

            document.getElementById('return-form').reset();
            document.getElementById('returnLocation').focus();
        }

        window.closeReturnModal = () => {
            currentEditingDocId = null;
            returnModal.classList.add('hidden');
            returnModal.classList.remove('flex');
        }

        // --- 7. REGISTRAR DEVOLUCI√ìN DE LLAVE (RETURN) ---
        async function handleReturn(e) {
            e.preventDefault();

            if (!securityId) {
                showMessage("Debe iniciar sesi√≥n para registrar una devoluci√≥n.", 'error');
                closeReturnModal();
                return;
            }

            if (!currentEditingDocId) {
                showMessage("Error: ID de registro no encontrado.", 'error');
                closeReturnModal();
                return;
            }

            const returnSubmitText = document.getElementById('return-submit-text');
            const returnSubmitLoading = document.getElementById('return-submit-loading');
            const confirmReturnBtn = document.getElementById('confirm-return-btn');

            confirmReturnBtn.disabled = true;
            returnSubmitText.classList.add('hidden');
            returnSubmitLoading.classList.remove('hidden');

            const formData = new FormData(e.target);
            const returnData = {
                isReturned: true,
                returnTime: Date.now(), 
                returnLocation: formData.get('returnLocation'), 
                returnObservation: formData.get('returnObservation').trim() || 'N/A',
                returnUserId: securityId, 
            };

            const logs = loadLogs();
            const logIndex = logs.findIndex(log => log.id === currentEditingDocId);

            if (logIndex !== -1) {
                logs[logIndex] = { ...logs[logIndex], ...returnData };
                saveLogs(logs);
                renderKeyList();

                showMessage("Devoluci√≥n de llave registrada con √©xito.", 'success');
            } else {
                showMessage("Error: El registro a devolver no fue encontrado.", 'error');
            }

            closeReturnModal();
            confirmReturnBtn.disabled = false;
            returnSubmitText.classList.remove('hidden');
            returnSubmitLoading.classList.add('hidden');
        }


        // ******************************************************************
        // ************ FUNCI√ìN DE EXPORTACI√ìN CON jsPDF.autoTable() *********
        // ******************************************************************

        function addReportHeaderAndFooter(doc, pageWidth, margin) {
            const pageHeight = doc.internal.pageSize.height;
            let yPos = 15;

            // T√çTULOS
            doc.setFontSize(16).setFont('helvetica', 'bold');
            doc.setTextColor(28, 69, 135); // Azul Acero
            doc.text("GRUPO RIBA SMITH", pageWidth / 2, yPos, { align: 'center' });
            yPos += 6;
            doc.setFontSize(12).setFont('helvetica', 'normal');
            doc.text("R/S CHITR√â SELECTO", pageWidth / 2, yPos, { align: 'center' });
            yPos += 5;

            doc.setFontSize(14).setFont('helvetica', 'bold');
            doc.setTextColor(41, 128, 185); // Azul Claro
            doc.text("REPORTE DIARIO DE CONTROL DE LLAVES", pageWidth / 2, yPos, { align: 'center' });
            yPos += 8;

            // INFORMACI√ìN DE FECHA Y USUARIO
            const todayDate = new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            doc.setFontSize(10).setFont('helvetica', 'normal');
            doc.setTextColor(75, 85, 99); 
            doc.text(`Fecha del Reporte: ${todayDate}`, margin, yPos);
            doc.text(`Generado por ID de Seguridad: ${securityId}`, pageWidth - margin, yPos, { align: 'right' });
            yPos += 5;

            // PIE DE P√ÅGINA
            doc.setFontSize(8).setFont('helvetica', 'normal');
            doc.setTextColor(107, 114, 128); 
            const footerText = 'Powered by Rafael Ramos | P√°gina ' + doc.internal.getNumberOfPages();
            doc.text(footerText, pageWidth / 2, pageHeight - 5, { align: 'center' });

            return yPos + 3; 
        }

        window.generateDailyReportPdf = function() {
            if (!securityId) {
                showMessage("Debe iniciar sesi√≥n para generar el reporte.", 'error');
                return;
            }

            let jsPDF_Constructor;

            if (typeof jsPDF !== 'undefined') {
                jsPDF_Constructor = jsPDF;
            } 
            else if (window.jspdf && window.jspdf.jsPDF) {
                jsPDF_Constructor = window.jspdf.jsPDF;
            } 
            else {
                showMessage("‚ùå ERROR: La librer√≠a jsPDF y/o el plugin autotable no est√°n cargados correctamente. Verifique la conexi√≥n a internet.", 'error');
                return;
            }

            // Inicializar jsPDF
            const doc = new jsPDF_Constructor('p', 'mm', 'a4'); 

            if (typeof doc.autoTable !== 'function') {
                showMessage("‚ùå ERROR: El plugin jsPDF AutoTable no se carg√≥.", 'error');
                return;
            }

            const logs = loadLogs();
            const startOfToday = getStartOfToday();
            const todayLogs = logs.filter(log => log.checkoutTime >= startOfToday)
                                  .sort((a, b) => a.checkoutTime - b.checkoutTime);

            if (todayLogs.length === 0) {
                showMessage("No hay registros de entrega para el d√≠a de hoy para generar el reporte.", 'info');
                return;
            }

            const margin = 10;
            const pageWidth = doc.internal.pageSize.getWidth();

            // Re-a√±adir el encabezado para la primera p√°gina
            let currentY = addReportHeaderAndFooter(doc, pageWidth, margin); 

            const headers = [
                "Activo", 
                "Usuario", 
                "Depto (ENT)", 
                "ID Ent",
                "Hora Ent",
                "Firma (ENT)", // √çndice 5
                "Estado",
                "ID Ret",
                "Hora Ret",
                "Obs. (ENTREGA)",
                "Obs. (RETORNA)"
            ];

            // Preparar el cuerpo de la tabla
            const body = todayLogs.map(log => {
                const hourEnt = formatTimeForPdf(log.checkoutTime);
                const hourRet = log.isReturned ? formatTimeForPdf(log.returnTime) : 'N/A';
                const status = log.isReturned ? 'DEVUELTO' : 'PENDIENTE';

                let signatureImage = null;
                // Filtrado: SOLO se procesan firmas que sean PNGs (las nuevas, peque√±as y corregidas)
                if (log.checkoutSignature && typeof log.checkoutSignature === 'string' && 
                   log.checkoutSignature.startsWith('data:image/png')) { 
                    signatureImage = log.checkoutSignature;
                }

                return [
                    log.keyRequested || 'N/A',
                    log.userName || 'N/A',
                    log.checkoutLocation || 'N/A',
                    log.checkoutUserId || 'N/A', 
                    hourEnt,
                    signatureImage || 'N/A', // Firma optimizada o 'N/A'
                    status,
                    log.returnUserId || 'N/A', 
                    hourRet,
                    log.checkoutObservation || 'N/A',
                    log.returnObservation || 'N/A'
                ];
            });

            // 3. GENERACI√ìN DE LA TABLA CON ESTILO
            doc.autoTable({
                startY: currentY,
                head: [headers],
                body: body,
                theme: 'grid', // Usamos grid para mayor formalidad
                headStyles: { 
                    fillColor: [28, 69, 135], // Azul Acero
                    textColor: 255, 
                    fontStyle: 'bold',
                    fontSize: 7, 
                    halign: 'center' 
                },
                styles: {
                    fontSize: 6, 
                    cellPadding: 1, 
                    overflow: 'linebreak' 
                },
                columnStyles: {
                    0: { cellWidth: 12, halign: 'center' }, // Activo
                    1: { cellWidth: 16 }, // Usuario
                    2: { cellWidth: 14 }, // Depto (ENT)
                    3: { cellWidth: 8, halign: 'center' }, // ID Ent
                    4: { cellWidth: 8, halign: 'center' }, // Hora Ent
                    5: { cellWidth: 18, halign: 'center', minCellHeight: 12, valign: 'middle' }, // FIRMA (Ajustado para la imagen optimizada)
                    6: { cellWidth: 13, fontStyle: 'bold', halign: 'center' }, // Estado 
                    7: { cellWidth: 8, halign: 'center' }, // ID Ret
                    8: { cellWidth: 8, halign: 'center' }, // Hora Ret
                    9: { cellWidth: 32 }, // Obs. (ENTREGA)
                    10: { cellWidth: 32 }  // Obs. (RETORNA)
                },
                margin: { left: margin, right: margin },

                didDrawPage: (data) => {
                    addReportHeaderAndFooter(doc, pageWidth, margin);
                },

                // Manejo de la imagen de firma optimizada
                didDrawCell: (data) => {
                    // Columna de Firma (√çndice 5) y solo en el cuerpo de la tabla
                    if (data.column.index === 5 && data.cell.section === 'body') {
                        const firmaDataURL = data.cell.raw; 
                        
                        if (firmaDataURL && typeof firmaDataURL === 'string' && firmaDataURL.startsWith('data:image/png')) {
                            
                            const cellWidth = data.cell.width;
                            const cellHeight = data.cell.height;
                            const imgPadding = 0.5; 
                            
                            // Usar dimensiones de la celda menos padding
                            const imgWidth = cellWidth - (2 * imgPadding);
                            const imgHeight = cellHeight - (2 * imgPadding);

                            // La imagen ya est√° redimensionada, solo la dibujamos
                            doc.addImage(
                                firmaDataURL, 
                                'PNG', 
                                data.cell.x + imgPadding, 
                                data.cell.y + imgPadding, 
                                imgWidth, 
                                imgHeight
                            );
                        } else if (firmaDataURL === 'N/A') {
                            // Centrar 'N/A'
                            doc.setFontSize(7).setTextColor(100, 100, 100);
                            doc.text('N/A', data.cell.x + (data.cell.width / 2), data.cell.y + (data.cell.height / 2), {
                                 align: 'center', 
                                 baseline: 'middle'
                            });
                        }
                    } 
                    
                    // Aplicar el estilo condicional para el estado (Columna 6)
                    if (data.column.index === 6 && data.cell.section === 'body') { 
                        const status = data.cell.text[0];
                        if (status === 'PENDIENTE') {
                            data.cell.styles.fillColor = [253, 242, 218]; // Amarillo/Crema
                            doc.setTextColor(180, 83, 9); 
                        } else if (status === 'DEVUELTO') {
                            data.cell.styles.fillColor = [220, 252, 231]; // Verde muy claro
                            doc.setTextColor(5, 150, 105); 
                        }
                        data.cell.styles.fontStyle = 'bold';
                    }
                }
            });

            const filename = `Reporte_ControlLlaves_${new Date().toISOString().slice(0, 10)}.pdf`;
            doc.save(filename);

            showMessage(`PDF de reporte diario generado y descargado: ${filename}`, 'success');
        }
    </script>
</body>
</html>
