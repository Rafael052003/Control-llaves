<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Llaves - Con Firma Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script> 
    
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script> 

    <link rel="manifest" href="manifest.json">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2ff; /* Fondo muy suave azul */
        }
        /* Estilos generales de la aplicaci√≥n */
        .app-container {
            @apply max-w-4xl mx-auto p-4 md:p-8;
        }
        .card {
            @apply bg-white p-6 rounded-2xl shadow-xl border border-indigo-100/50 transition-all duration-300;
        }
        .btn-primary {
            @apply px-6 py-3 font-bold text-white bg-indigo-600 rounded-xl shadow-lg hover:bg-indigo-700 transition-colors duration-200 focus:outline-none focus:ring-4 focus:ring-indigo-300;
        }
        .btn-success {
            @apply px-4 py-2 font-semibold text-white bg-green-600 rounded-xl hover:bg-green-700 transition-colors duration-200 focus:outline-none focus:ring-4 focus:ring-green-300;
        }
        .btn-report {
            @apply px-4 py-2 font-semibold text-white bg-red-600 rounded-xl hover:bg-red-700 transition-colors duration-200 focus:outline-none focus:ring-4 focus:ring-red-300;
        }
    </style>
</head>
<body>

    <div id="login-modal" class="fixed inset-0 bg-indigo-900 bg-opacity-95 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-sm transform transition-transform duration-500 ease-out">
            <h3 class="text-3xl font-extrabold mb-4 text-indigo-700 text-center">Acceso de Seguridad</h3>
            <p class="text-gray-600 mb-6 text-center">Seleccione su nombre e ingrese su contrase√±a.</p>

            <form id="login-form" class="space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Nombre de Agente de Seguridad</label>
                    <select id="username" name="username" required 
                           class="mt-1 block w-full border border-gray-300 rounded-xl shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 appearance-none bg-white">
                        <option value="">-- Seleccione su Nombre --</option>
                        <option value="Rafael Ramos">Rafael Ramos</option>
                        <option value="Jos√© Guevara">Jos√© Guevara</option>
                        <option value="Ariel Bernal">Ariel Bernal</option>
                        <option value="Oriel Aizprua">Oriel Aizprua</option>
                        <option value="Leandro P√©rez">Leandro P√©rez</option>
                        <option value="Samuel Reyes">Samuel Reyes</option>
                    </select>
                </div>

                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Contrase√±a</label>
                    <input type="password" id="password" name="password" required 
                           class="mt-1 block w-full border border-gray-300 rounded-xl shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500"
                           placeholder="Contrase√±a">
                </div>

                <div id="login-error" class="hidden text-red-600 text-sm font-semibold">Credenciales incorrectas.</div>

                <button type="submit" class="btn-primary w-full mt-6">
                    Iniciar Sesi√≥n
                </button>
            </form>
        </div>
    </div>
    <div id="main-app-content" class="app-container hidden">

        <header class="text-center py-8 mb-4 bg-indigo-700 text-white rounded-b-3xl shadow-2xl flex justify-between items-center px-6">
            <h1 class="text-2xl md:text-4xl font-extrabold tracking-tight">Control de Llaves</h1>
            <button id="logout-btn" onclick="handleLogout()" class="px-3 py-1.5 font-semibold text-xs bg-white text-indigo-700 rounded-lg hover:bg-gray-100 transition-colors">
                Cerrar Sesi√≥n
            </button>
        </header>

        <div class="mb-6 flex justify-center">
            <button id="end-day-report-btn" onclick="generateDailyReportPdf()" class="btn-report flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M14 3v4a1 1 0 0 0 1 1h4"></path><path d="M17 21H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7l5 5v11a2 2 0 0 1-2 2z"></path><line x1="10" y1="13" x2="14" y2="13"></line><line x1="12" y1="17" x2="12" y2="17"></line></svg>
                <span>Terminar D√≠a</span>
            </button>
        </div>

        <div id="message-container"></div>
        <div id="auth-status" class="mb-10 card text-sm">
            <p class="flex items-center justify-between">
                ID de Seguridad Activo: 
                <span id="security-id" class="font-mono text-xs bg-indigo-100 text-indigo-700 p-2 rounded-lg font-bold"></span>
            </p>
        </div>

        <div id="checkout-section" class="card mb-12">
            <h2 class="text-2xl font-bold text-indigo-700 mb-4 pb-2 border-b border-indigo-100">1. Registrar Entrega de Llave</h2>

            <form id="checkout-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="userName" class="block text-sm font-medium text-gray-700">Usuario que Solicita</label>
                        <select id="userName" name="userName" required class="mt-1 block w-full border border-gray-300 rounded-xl shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 appearance-none bg-white">
                            <option value="">-- Seleccione Usuario --</option>
                            <option value="Rafael Ramos">Rafael Ramos</option>
                            <option value="Jos√© Guevara">Jos√© Guevara</option>
                            <option value="Ariel Bernal">Ariel Bernal</option>
                            <option value="Oriel Aizprua">Oriel Aizprua</option>
                            <option value="Leandro P√©rez">Leandro P√©rez</option>
                            <option value="Samuel Reyes">Samuel Reyes</option>
                        </select>
                    </div>

                    <div>
                        <label for="keyRequested" class="block text-sm font-medium text-gray-700">Llave Solicitada</label>
                        <select id="keyRequested" name="keyRequested" required class="mt-1 block w-full border border-gray-300 rounded-xl shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 appearance-none bg-white">
                            <option value="">-- Seleccione Activo --</option>
                            <option value="Deposito">Deposito</option>
                            <option value="Contenedor">Contenedor</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label for="checkoutLocation" class="block text-sm font-medium text-gray-700">Departamento</label>
                    <select id="checkoutLocation" name="checkoutLocation" required class="mt-1 block w-full border border-gray-300 rounded-xl shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 appearance-none bg-white">
                        <option value="">-- Seleccione Departamento --</option>
                        <option value="Rimith">Rimith</option>
                        <option value="Nevera">Nevera</option>
                        <option value="Panaderia">Panader√≠a</option>
                        <option value="Estanteria">Estanter√≠a</option>
                        <option value="Sanidad">Sanidad</option>
                        <option value="Recibo">Recibo</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Firma del Solicitante (Entregado)</label>
                    <div class="border border-gray-300 rounded-xl bg-gray-50 p-1 h-40">
                        <canvas id="signature-pad-checkout" width="400" height="150" class="w-full h-full bg-white rounded-lg cursor-crosshair border border-dashed border-indigo-200"></canvas>
                    </div>
                    <button type="button" id="clear-signature-checkout" class="mt-1 px-3 py-1 text-xs font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">Borrar Firma</button>
                </div>
                <div>
                    <label for="checkoutObservation" class="block text-sm font-medium text-gray-700">Observaci√≥n (Opcional)</label>
                    <textarea id="checkoutObservation" name="checkoutObservation" rows="2" class="mt-1 block w-full border border-gray-300 rounded-xl shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>

                <button type="submit" id="checkout-submit-btn" class="btn-primary w-full mt-6">
                    <span id="submit-text">Registrar Entrega</span>
                    <span id="submit-loading" class="hidden flex items-center justify-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        Guardando...
                    </span>
                </button>
            </form>
        </div>

        <div id="pending-section" class="card">
            <h2 class="text-2xl font-bold text-indigo-700 mb-6 pb-2 border-b border-indigo-100">2. Llaves Pendientes de Devoluci√≥n</h2>

            <div id="key-list-container">
                <div id="key-list-loading" class="text-center py-8 text-gray-500">
                    <svg class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"></svg>
                    Cargando historial de llaves...
                </div>
                <div id="pending-keys-list" class="space-y-4">
                    </div>
                <div id="key-list-empty" class="hidden text-center py-8 text-gray-500">
                    <p class="text-lg">üéâ ¬°Todas las llaves han sido devueltas! No hay registros pendientes.</p>
                </div>
            </div>
        </div>

        <div id="return-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md">
                <h3 class="text-xl font-bold mb-4 text-indigo-700 border-b pb-2">Confirmar Devoluci√≥n</h3>
                <p class="text-gray-600 mb-4">Confirmar devoluci√≥n de: <strong id="modal-key-name" class="text-indigo-600 font-extrabold"></strong>.</p>
                <p class="text-gray-500 text-sm mb-4">Solicitada por: <span id="modal-user-name" class="font-semibold"></span></p>

                <form id="return-form" class="space-y-4">
                    <div>
                        <label for="returnLocation" class="block text-sm font-medium text-gray-700">Lugar de Devoluci√≥n</label>
                        <select id="returnLocation" name="returnLocation" required class="mt-1 block w-full border border-gray-300 rounded-xl shadow-sm p-3 focus:ring-green-500 focus:border-green-500 appearance-none bg-white">
                            <option value="">-- Seleccione Lugar --</option>
                            <option value="Seguridad Interno">Seguridad Interno</option>
                            <option value="Oficina de seguridad">Oficina de seguridad</option>
                            <option value="Entregada a otro personal">Entregada a otro personal</option>
                            </select>
                    </div>

                    <div>
                        <label for="returnObservation" class="block text-sm font-medium text-gray-700">Observaci√≥n de Devoluci√≥n (Opcional)</label>
                        <textarea id="returnObservation" name="returnObservation" rows="2" class="mt-1 block w-full border border-gray-300 rounded-xl shadow-sm p-3 focus:ring-green-500 focus:border-green-500"></textarea>
                    </div>

                    <div class="flex justify-end space-x-3 pt-2">
                        <button type="button" onclick="closeReturnModal()" class="px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-xl hover:bg-gray-300 transition-colors duration-200">Cancelar</button>
                        <button type="submit" id="confirm-return-btn" class="btn-success">
                            <span id="return-submit-text">Confirmar Devoluci√≥n</span>
                            <span id="return-submit-loading" class="hidden flex items-center justify-center">
                                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                Procesando...
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <script>
        const STORAGE_KEY = 'keyControlLogs';
        const SESSION_KEY = 'currentSecurityId';

        // --- Nombres de Guardia de Seguridad y sus credenciales ---
        const VALID_USERS = {
            'Rafael Ramos': { password: '1234', id: 'RR 19075' },
            'Jos√© Guevara': { password: '1234', id: 'JG 5604' },
            'Ariel Bernal': { password: '1234', id: 'AB 22750' },
            'Oriel Aizprua': { password: '1234', id: 'OA 17411' },
            'Leandro P√©rez': { password: '1234', id: 'LP 26511' },
            'Samuel Reyes': { password: '1234', id: 'SR 26113' }
        };

        let securityId = null; 
        let signaturePadCheckout; 

        // --- 1. AUTHENTICATION FUNCTIONS ---

        function updateUIForLogin(id) {
            securityId = id;
            document.getElementById('security-id').textContent = id;
            document.getElementById('main-app-content').classList.remove('hidden');
            document.getElementById('login-modal').classList.add('hidden');
            renderKeyList(); 
        }

        function handleLogin(e) {
            e.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorDiv = document.getElementById('login-error');

            if (VALID_USERS[username] && VALID_USERS[username].password === password) {
                sessionStorage.setItem(SESSION_KEY, VALID_USERS[username].id);
                updateUIForLogin(VALID_USERS[username].id);
                errorDiv.classList.add('hidden');
                showMessage(`Bienvenido, ${username}! (ID: ${VALID_USERS[username].id})`, 'success');
            } else {
                errorDiv.classList.remove('hidden');
            }
        }

        window.handleLogout = function() {
            sessionStorage.removeItem(SESSION_KEY);
            securityId = null;
            document.getElementById('main-app-content').classList.add('hidden');
            document.getElementById('login-modal').classList.remove('hidden');
            showMessage("Sesi√≥n cerrada correctamente.", 'info');
        }

        function checkLoginStatus() {
            const storedId = sessionStorage.getItem(SESSION_KEY);
            if (storedId && Object.values(VALID_USERS).some(user => user.id === storedId)) {
                updateUIForLogin(storedId);
            } else {
                document.getElementById('login-modal').classList.remove('hidden');
                document.getElementById('main-app-content').classList.add('hidden');
            }
        }


        // --- 2. UTILITY FUNCTIONS ---

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function loadLogs() {
            try {
                const json = localStorage.getItem(STORAGE_KEY);
                return json ? JSON.parse(json) : [];
            } catch (error) {
                console.error("Error al cargar logs de localStorage:", error);
                return [];
            }
        }

        function saveLogs(logs) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
            } catch (error) {
                console.error("Error al guardar logs en localStorage:", error);
                showMessage("Error al guardar datos. El almacenamiento local est√° lleno.", 'error');
            }
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            const dateOptions = { year: 'numeric', month: 'short', day: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit' };

            return `${date.toLocaleDateString('es-ES', dateOptions)} ${date.toLocaleTimeString('es-ES', timeOptions)}`;
        }

        function formatTimeForPdf(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', hour12: false });
        }

        function showMessage(message, type = 'info') {
            const container = document.getElementById('message-container');
            let bgColor = 'bg-blue-100 border-blue-400 text-blue-700';
            let icon = '‚ÑπÔ∏è';
            if (type === 'error') { bgColor = 'bg-red-100 border-red-400 text-red-700'; icon = '‚ùå'; }
            if (type === 'success') { bgColor = 'bg-green-100 border-green-400 text-green-700'; icon = '‚úÖ'; }

            const msgDiv = document.createElement('div');
            msgDiv.className = `p-4 rounded-xl shadow-lg border ${bgColor} mb-4 flex items-center space-x-3 transition-opacity duration-300`;
            msgDiv.innerHTML = `<span class="text-2xl">${icon}</span><p class="font-medium">${message}</p>`;

            container.innerHTML = '';
            container.appendChild(msgDiv);

            setTimeout(() => {
                msgDiv.classList.add('opacity-0');
                msgDiv.addEventListener('transitionend', () => msgDiv.remove());
            }, 5000);
        }

        function getStartOfToday() {
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            return now.getTime();
        }

        // --- 3. INITIALIZATION AND UI SETUP ---

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('checkout-form').addEventListener('submit', handleCheckout);
            document.getElementById('return-form').addEventListener('submit', handleReturn);
            document.getElementById('login-form').addEventListener('submit', handleLogin);

            const canvasCheckout = document.getElementById('signature-pad-checkout');
            if (canvasCheckout) {
                
                // Funci√≥n de redimensionamiento mejorada y forzada
                function resizeCanvas() {
                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                    canvasCheckout.width = canvasCheckout.offsetWidth * ratio; 
                    canvasCheckout.height = canvasCheckout.offsetHeight * ratio;
                    canvasCheckout.getContext("2d").scale(ratio, ratio);
                }

                // Forzar la primera ejecuci√≥n para que tenga altura ANTES de SignaturePad
                resizeCanvas(); 
                setTimeout(resizeCanvas, 100); 

                window.addEventListener('resize', resizeCanvas);

                signaturePadCheckout = new SignaturePad(canvasCheckout, {
                    backgroundColor: 'rgb(255, 255, 255)' 
                });

                document.getElementById('clear-signature-checkout').addEventListener('click', () => {
                    signaturePadCheckout.clear();
                });
            }

            checkLoginStatus();
            document.getElementById('key-list-loading').classList.add('hidden');
        });


        // --- 4. REGISTRAR ENTREGA DE LLAVE (CHECKOUT) CON FIRMA ---
        async function handleCheckout(e) {
            e.preventDefault();

            if (!securityId) {
                showMessage("Debe iniciar sesi√≥n para registrar una entrega.", 'error');
                return;
            }

            if (signaturePadCheckout && signaturePadCheckout.isEmpty()) {
                showMessage("Por favor, el solicitante debe firmar en el recuadro antes de registrar la entrega.", 'error');
                return;
            }

            const submitText = document.getElementById('submit-text');
            const submitLoading = document.getElementById('submit-loading');
            const checkoutSubmitBtn = document.getElementById('checkout-submit-btn');

            checkoutSubmitBtn.disabled = true;
            submitText.classList.add('hidden');
            submitLoading.classList.remove('hidden');

            const formData = new FormData(e.target);
            
            // Generar la Data URL de la firma con formato JPEG (menor tama√±o)
            // *** CORRECCI√ìN CLAVE 1: Forzar una resoluci√≥n para la Data URL ***
            const canvas = signaturePadCheckout.canvas;
            const originalRatio = canvas.width / canvas.height;
            // Definir un ancho de destino en p√≠xeles
            const targetWidth = 400; 
            const targetHeight = targetWidth / originalRatio; 

            // Exportar la firma forzando el escalado interno
            const signatureDataURL = signaturePadCheckout ? 
                signaturePadCheckout.toDataURL('image/jpeg', 0.8) : // Usamos la funci√≥n b√°sica de toDataURL ya que la versi√≥n con dimensiones puede ser incompatible
                null;
            
            // OPTIMIZACI√ìN (Si la firma es grande y ocupa mucho espacio en local storage)
            // Si la librer√≠a soporta el escalado, se usar√≠a:
            // signaturePadCheckout.toDataURL('image/jpeg', 0.8, targetWidth, targetHeight);
            // Por ahora, usamos la versi√≥n est√°ndar y confiamos en el ajuste de jsPDF

            const newLog = {
                id: generateUUID(), 
                userName: formData.get('userName').trim(), 
                keyRequested: formData.get('keyRequested').trim(), 
                checkoutLocation: formData.get('checkoutLocation'), 
                checkoutObservation: formData.get('checkoutObservation').trim() || 'N/A',
                isReturned: false, 

                checkoutTime: Date.now(), 
                checkoutUserId: securityId, 
                
                // GUARDAR FIRMA COMO Base64
                checkoutSignature: signatureDataURL, 
            };

            const logs = loadLogs();
            logs.push(newLog);
            saveLogs(logs);
            renderKeyList();

            showMessage("Entrega de llave registrada con √©xito.", 'success');
            e.target.reset(); 
            if (signaturePadCheckout) signaturePadCheckout.clear(); 

            checkoutSubmitBtn.disabled = false;
            submitText.classList.remove('hidden');
            submitLoading.classList.add('hidden');
        }


        // --- 5. RENDERIZAR LISTA DE LLAVES PENDIENTES ---
        function renderKeyList() {
            const logs = loadLogs();
            const pendingKeys = logs.filter(log => !log.isReturned);

            pendingKeys.sort((a, b) => a.checkoutTime - b.checkoutTime);

            const pendingKeysList = document.getElementById('pending-keys-list');
            const keyListEmpty = document.getElementById('key-list-empty');

            pendingKeysList.innerHTML = ''; 

            if (pendingKeys.length === 0) {
                keyListEmpty.classList.remove('hidden');
                return;
            }

            keyListEmpty.classList.add('hidden');

            pendingKeys.forEach(key => {
                const checkoutTimeFormatted = formatTimestamp(key.checkoutTime);

                const keyCard = document.createElement('div');
                keyCard.className = 'card bg-yellow-50 border-yellow-300 shadow-md flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-3 sm:space-y-0 p-4';
                keyCard.innerHTML = `
                    <div class="flex-1 w-full">
                        <p class="text-xl font-extrabold text-indigo-800">${key.keyRequested}</p>
                        <p class="text-sm text-gray-700 mb-1">
                            <span class="font-bold">Solicita:</span> ${key.userName} 
                            <span class="text-xs text-gray-500 ml-2">(${key.checkoutLocation})</span>
                        </p>
                        <p class="text-xs text-gray-500 mt-1">
                            <span class="font-bold text-indigo-500">ENTREGA:</span> ${checkoutTimeFormatted} 
                            <span class="text-gray-400">por ${key.checkoutUserId}</span>
                        </p>
                        <p class="text-xs text-gray-500 italic mt-0.5">Obs: ${key.checkoutObservation}</p>
                    </div>
                    <button data-id="${key.id}" data-key="${key.keyRequested}" data-user="${key.userName}" 
                            class="btn-success w-full sm:w-auto log-return-btn text-sm">
                        RETORNA
                    </button>
                `;
                pendingKeysList.appendChild(keyCard);
            });

            document.querySelectorAll('.log-return-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const docId = e.currentTarget.getAttribute('data-id');
                    const keyName = e.currentTarget.getAttribute('data-key');
                    const userName = e.currentTarget.getAttribute('data-user');
                    openReturnModal(docId, keyName, userName);
                });
            });
        }

        // --- 6. GESTI√ìN DEL MODAL Y DEVOLUCI√ìN ---
        const returnModal = document.getElementById('return-modal');
        const modalKeyName = document.getElementById('modal-key-name');
        const modalUserName = document.getElementById('modal-user-name');
        let currentEditingDocId = null;

        window.openReturnModal = (docId, keyName, userName) => {
            currentEditingDocId = docId;
            modalKeyName.textContent = keyName;
            modalUserName.textContent = userName;
            returnModal.classList.remove('hidden');
            returnModal.classList.add('flex');

            document.getElementById('return-form').reset();
            document.getElementById('returnLocation').focus();
        }

        window.closeReturnModal = () => {
            currentEditingDocId = null;
            returnModal.classList.add('hidden');
            returnModal.classList.remove('flex');
        }

        // --- 7. REGISTRAR DEVOLUCI√ìN DE LLAVE (RETURN) ---
        async function handleReturn(e) {
            e.preventDefault();

            if (!securityId) {
                showMessage("Debe iniciar sesi√≥n para registrar una devoluci√≥n.", 'error');
                closeReturnModal();
                return;
            }

            if (!currentEditingDocId) {
                showMessage("Error: ID de registro no encontrado.", 'error');
                closeReturnModal();
                return;
            }

            const returnSubmitText = document.getElementById('return-submit-text');
            const returnSubmitLoading = document.getElementById('return-submit-loading');
            const confirmReturnBtn = document.getElementById('confirm-return-btn');

            confirmReturnBtn.disabled = true;
            returnSubmitText.classList.add('hidden');
            returnSubmitLoading.classList.remove('hidden');

            const formData = new FormData(e.target);
            const returnData = {
                isReturned: true,
                returnTime: Date.now(), 
                returnLocation: formData.get('returnLocation'), 
                returnObservation: formData.get('returnObservation').trim() || 'N/A',
                returnUserId: securityId, 
            };

            const logs = loadLogs();
            const logIndex = logs.findIndex(log => log.id === currentEditingDocId);

            if (logIndex !== -1) {
                logs[logIndex] = { ...logs[logIndex], ...returnData };
                saveLogs(logs);
                renderKeyList();

                showMessage("Devoluci√≥n de llave registrada con √©xito.", 'success');
            } else {
                showMessage("Error: El registro a devolver no fue encontrado.", 'error');
            }

            closeReturnModal();
            confirmReturnBtn.disabled = false;
            returnSubmitText.classList.remove('hidden');
            returnSubmitLoading.classList.add('hidden');
        }


        // ******************************************************************
        // ************ FUNCI√ìN DE EXPORTACI√ìN CON jsPDF.autoTable() *********
        // ******************************************************************

        function addReportHeaderAndFooter(doc, pageWidth, margin) {
            const pageHeight = doc.internal.pageSize.height;
            let yPos = 15;

            // T√çTULOS
            doc.setFontSize(16).setFont('helvetica', 'bold');
            doc.setTextColor(44, 62, 80); 
            doc.text("GRUPO RIBA SMITH", pageWidth / 2, yPos, { align: 'center' });
            yPos += 6;
            doc.setFontSize(12).setFont('helvetica', 'normal');
            doc.text("R/S CHITR√â SELECTO", pageWidth / 2, yPos, { align: 'center' });
            yPos += 5;

            doc.setFontSize(14).setFont('helvetica', 'bold');
            doc.setTextColor(52, 152, 219); 
            doc.text("REPORTE DIARIO DE CONTROL DE LLAVES", pageWidth / 2, yPos, { align: 'center' });
            yPos += 8;

            // INFORMACI√ìN DE FECHA Y USUARIO
            const todayDate = new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            doc.setFontSize(10).setFont('helvetica', 'normal');
            doc.setTextColor(75, 85, 99); 
            doc.text(`Fecha del Reporte: ${todayDate}`, margin, yPos);
            doc.text(`Generado por ID de Seguridad: ${securityId}`, pageWidth - margin, yPos, { align: 'right' });
            yPos += 5;

            // PIE DE P√ÅGINA
            doc.setFontSize(8).setFont('helvetica', 'normal');
            doc.setTextColor(107, 114, 128); 
            const footerText = 'Powered by Rafael Ramos | P√°gina ' + doc.internal.getNumberOfPages();
            doc.text(footerText, pageWidth / 2, pageHeight - 5, { align: 'center' });

            return yPos + 3; 
        }

        window.generateDailyReportPdf = function() {
            if (!securityId) {
                showMessage("Debe iniciar sesi√≥n para generar el reporte.", 'error');
                return;
            }

            let jsPDF_Constructor;

            if (typeof jsPDF !== 'undefined') {
                jsPDF_Constructor = jsPDF;
            } 
            else if (window.jspdf && window.jspdf.jsPDF) {
                jsPDF_Constructor = window.jspdf.jsPDF;
            } 
            else {
                showMessage("‚ùå ERROR: La librer√≠a jsPDF y/o el plugin autotable no est√°n cargados correctamente. Verifique la conexi√≥n a internet.", 'error');
                return;
            }

            // Inicializar jsPDF
            const doc = new jsPDF_Constructor('p', 'mm', 'a4'); 

            if (typeof doc.autoTable !== 'function') {
                showMessage("‚ùå ERROR: El plugin jsPDF AutoTable no se carg√≥.", 'error');
                return;
            }


            const logs = loadLogs();
            const startOfToday = getStartOfToday();
            const todayLogs = logs.filter(log => log.checkoutTime >= startOfToday)
                                  .sort((a, b) => a.checkoutTime - b.checkoutTime);

            if (todayLogs.length === 0) {
                showMessage("No hay registros de entrega para el d√≠a de hoy para generar el reporte.", 'info');
                return;
            }

            const margin = 10;
            const pageWidth = doc.internal.pageSize.getWidth();

            // Re-a√±adir el encabezado para la primera p√°gina
            let currentY = addReportHeaderAndFooter(doc, pageWidth, margin); 

            const headers = [
                "Activo", 
                "Usuario", 
                "Depto (ENT)", 
                "ID Ent",
                "Hora Ent",
                "Firma (ENT)", // √çndice 5
                "Estado",
                "ID Ret",
                "Hora Ret",
                "Obs. (ENTREGA)",
                "Obs. (RETORNA)"
            ];

            const body = todayLogs.map(log => {
                const hourEnt = formatTimeForPdf(log.checkoutTime);
                const hourRet = log.isReturned ? formatTimeForPdf(log.returnTime) : 'N/A';
                const status = log.isReturned ? 'DEVUELTO' : 'PENDIENTE';

                let signatureImage = null;
                if (log.checkoutSignature && log.checkoutSignature.length > 500) { 
                    signatureImage = log.checkoutSignature;
                }

                return [
                    log.keyRequested || 'N/A',
                    log.userName || 'N/A',
                    log.checkoutLocation || 'N/A',
                    log.checkoutUserId || 'N/A', 
                    hourEnt,
                    // Si hay firma, se inserta la Data URL. Si no, se deja 'N/A'
                    signatureImage || 'N/A', 
                    status,
                    log.returnUserId || 'N/A', 
                    hourRet,
                    log.checkoutObservation || 'N/A',
                    log.returnObservation || 'N/A'
                ];
            });

            // 3. GENERACI√ìN DE LA TABLA CON ESTILO
            doc.autoTable({
                startY: currentY,
                head: [headers],
                body: body,
                theme: 'striped', 
                headStyles: { 
                    fillColor: [44, 62, 80], 
                    textColor: 255, 
                    fontStyle: 'bold',
                    fontSize: 7, 
                    halign: 'center' 
                },
                styles: {
                    fontSize: 6, 
                    cellPadding: 1, 
                    overflow: 'linebreak' 
                },
                columnStyles: {
                    0: { cellWidth: 12, halign: 'center' }, // Activo
                    1: { cellWidth: 16 }, // Usuario
                    2: { cellWidth: 14 }, // Depto (ENT)
                    3: { cellWidth: 8, halign: 'center' }, // ID Ent
                    4: { cellWidth: 8, halign: 'center' }, // Hora Ent
                    5: { cellWidth: 18, halign: 'center', minCellHeight: 18, valign: 'middle' }, // FIRMA (Ajustado para la imagen)
                    6: { cellWidth: 13, fontStyle: 'bold', halign: 'center' }, // Estado 
                    7: { cellWidth: 8, halign: 'center' }, // ID Ret
                    8: { cellWidth: 8, halign: 'center' }, // Hora Ret
                    9: { cellWidth: 32 }, // Obs. (ENTREGA)
                    10: { cellWidth: 32 }  // Obs. (RETORNA)
                },
                margin: { left: margin, right: margin },

                didDrawPage: (data) => {
                    addReportHeaderAndFooter(doc, pageWidth, margin);
                },

                // CORRECCI√ìN CLAVE: AJUSTE DE DIMENSIONES PARA EVITAR LA BARRA NEGRA
                didDrawCell: (data) => {
                    // Columna de Firma (√çndice 5) y solo en el cuerpo de la tabla
                    if (data.column.index === 5 && data.cell.section === 'body') {
                        const firmaDataURL = data.cell.raw; 
                        
                        // 2. DIBUJAR LA FIRMA
                        if (firmaDataURL && typeof firmaDataURL === 'string' && firmaDataURL.startsWith('data:image/jpeg')) {
                            const cellWidth = data.cell.width;
                            const cellHeight = data.cell.height;

                            // Ajustamos el padding (en mm)
                            const imgPadding = 0.5; 
                            
                            // Usar las dimensiones de la celda menos el doble del padding.
                            const imgWidth = cellWidth - (2 * imgPadding);
                            const imgHeight = cellHeight - (2 * imgPadding);
                            
                            doc.addImage(
                                firmaDataURL, 
                                'JPEG', 
                                data.cell.x + imgPadding, 
                                data.cell.y + imgPadding, 
                                imgWidth, 
                                imgHeight // Forzamos la altura y ancho de la celda
                            );
                        } else if (firmaDataURL === 'N/A') {
                            // Centrar 'N/A' en la celda de la firma
                            doc.setFontSize(7).setTextColor(100, 100, 100);
                            doc.text('N/A', data.cell.x + (data.cell.width / 2), data.cell.y + (data.cell.height / 2), {
                                 align: 'center', 
                                 baseline: 'middle'
                            });
                        }
                    } 
                    
                    // Aplicar el estilo condicional para el estado (Columna 6)
                    if (data.column.index === 6 && data.cell.section === 'body') { 
                        const status = data.cell.text[0];
                        if (status === 'PENDIENTE') {
                            data.cell.styles.fillColor = [248, 215, 218];
                            doc.setTextColor(234, 88, 12); 
                        } else if (status === 'DEVUELTO') {
                            data.cell.styles.fillColor = [212, 237, 218]; 
                            doc.setTextColor(22, 163, 74); 
                        }
                    }
                }
            });

            const filename = `Reporte_ControlLlaves_${new Date().toISOString().slice(0, 10)}.pdf`;
            doc.save(filename);

            showMessage(`PDF de reporte diario generado y descargado: ${filename}`, 'success');
        }
    </script>
</body>
</html>
